import"./modulepreload-polyfill.c7c6310f.js";const view="";function $(t){return document.querySelector(t)}function $$(t){return document.querySelectorAll(t)}function addClass(t,o){return[t].concat(o).join(" ")}var cid=0,pid=0;window.onload=function(){HTMLTemplate.Init(),initTopBar();let t=/\d+$/.exec(window.location.pathname);if(t)cid=pid=parseInt(t[0]);else if(t=/pid=(\d+)/.exec(window.location.search),t)cid=pid=parseInt(t[1]);else throw new Error("Invalid url");loadBlog(pid),loadComment(pid),checkLogin(),initCommentPost(),window.addEventListener("scroll",()=>{var o=document.querySelector("#side-area"),c=o.getBoundingClientRect();c.top+c.height<=0?document.querySelector("#side-float").className="show":document.querySelector("#side-float").className="hide"}),$("#button-to-top").addEventListener("click",()=>{scrollToTop(.5)})};function scrollToTop(t){var o=.01667,c=window.scrollY/(t/o);window.scrollTo(0,window.scrollY-c),window.scrollY>0&&setTimeout(()=>scrollToTop(t-o),16)}function checkLogin(){$("#login").href="/account/login?redirect="+encodeURIComponent(window.location),SardineFish.API.User.checkAuth({}).then(t=>{document.querySelector("#account-area").className="login",document.querySelector("#user-avatar").src=`/api/user/${t}/avatar`,SardineFish.API.User.getInfo({}).then(o=>{$("#sender-avatar").src=o.avatar,$("#input-name").value=o.name,$("#input-email").value=o.email})})}function initSearch(){let t=!1;$("#search .icon-search").onclick=()=>{const o=$("#search-input").value;t?o?$("#search").submit():(t=!1,$("#search").classList.remove("expand")):(t=!0,$("#search").classList.add("expand"))}}function initTopBar(){var t=!1;$("#button-menu").addEventListener("click",function(){t?$("#top").classList.remove("extend-side"):$("#top").classList.add("extend-side"),t=!t}),initSearch()}function loadBlog(pid){var hljsLib="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1";$("#write").href="/blog/edit/"+pid,SardineFish.API.Blog.getByPid({pid}).then(data=>{if(data.time=SardineFish.API.Utils.formatDateTime(new Date(data.time)),data.doc_type===SardineFish.API.DocType.Markdown){var unknowLanguages={};if(new Date(data.time).getTime()<1546272e6){var renderer=markedImagePostProcess(marked);marked.setOptions({highlight:function(str,lang,callback){if(lang&&hljs.getLanguage(lang))try{return hljs.highlight(lang,str).value}catch{}else lang&&!unknowLanguages[lang]&&(unknowLanguages[lang]=fetch(`${hljsLib}/languages/${lang}.min.js`).then(t=>t.text()).then(code=>{eval(code),$$(`code.lang-${lang}`).forEach(t=>hljs.highlightBlock(t))}));return hljs.highlightAuto(str).value},renderer}),data.doc=marked(data.doc)}else{var md=window.markdownit({html:!0,xhtmlOut:!1,breaks:!0,langPrefix:"lang-",linkify:!0,typographer:!1,highlight:function(t,o){if(o&&hljs.getLanguage(o))try{return hljs.highlight(o,t).value}catch{}else o&&(unknowLanguages[o]=!0);return hljs.highlightAuto(t).value}});markdownItImagePostProcess(md),md.use(markdownitEmoji),md.use(markdownitKatex),data.doc=md.render(data.doc),Object.keys(unknowLanguages).forEach(lang=>{fetch(`${hljsLib}/languages/${lang}.min.js`).then(t=>t.text()).then(code=>{eval(code),$$(`code.lang-${lang}`).forEach(t=>hljs.highlightBlock(t))})})}}document.querySelector("#article-template").dataSource=data,loadContentNav(),$("#page-title").innerText=data.title,$("#loading").style.display="none",$$(".hide-loading").forEach(t=>t.className=t.className.replace("hide-loading","")),document.head.title=document.title=data.title,Promise.resolve().then(()=>{document.querySelectorAll("app").forEach(loadApp),new Date(data.time).getTime()>=1648567159012&&loadImageNote(),initImagePreview()})}).catch(t=>{switch(t.code){case 197122:t.code=404;break;default:t.code=`0x${t.code.toString(16)}`}$("#error-code").innerText=t.code,$("#load-error").className="show",$("#sun").onclick=()=>{$("#root").className.includes("darken")?$("#root").className=$("#root").className.replace("darken",""):$("#root").className=addClass($("#root").className,"darken")},loadPuzzle()})}function loadApp(t){const o=t.getAttribute("src"),c=t.getAttribute("name"),i=t.getAttribute("scale")||1,n=document.createElement("iframe"),a=document.createElement("div");{a.className="app-wrapper";const r=document.createElement("div");{r.className="app";const d=document.createElement("div");{d.className="cover";const u=document.createElement("header");u.innerText=c,d.appendChild(u);const m=document.createElement("div");m.className="button",m.innerText="CLICK TO LOAD",m.onclick=()=>{m.onclick=null,n.src=o,r.classList.add("load")},d.appendChild(m)}r.appendChild(d);{n.className="external";const u=t.getBoundingClientRect();console.log(u),n.width=u.width,n.height=window.innerWidth>window.innerHeight?Math.floor(n.width*9/16):Math.floor(n.width*16/9),r.style.width=`${n.width}px`,r.style.height=`${n.height}px`,n.width/=i,n.height/=i,n.style.transform=`scale(${i})`,n.style.transformOrigin="top left"}r.appendChild(n)}a.appendChild(r);const s=document.createElement("div");s.className="panel",s.innerHTML=`
<div class="icon-button button-reload">refresh</div>
<a class="icon-button button-new-tab" href="${o}" target="_blank">open_in_new</a>
<div class="icon-button button-full-window">aspect_ratio</div>
<div class="icon-button button-full-screen">fullscreen</div>
`,s.querySelector(".button-reload").onclick=()=>n.src=o,s.querySelector(".button-full-window").onclick=()=>{document.body.classList.add("full-window"),r.classList.add("full-window"),r.style.width="",r.style.height="",Promise.resolve().then(()=>l())},s.querySelector(".button-full-screen").onclick=()=>r.requestFullscreen({navigationUI:"hide"}),a.appendChild(s);const l=()=>{const d=r.getBoundingClientRect();console.log(d),n.width=d.width,n.height=window.innerWidth>window.innerHeight?Math.floor(n.width*9/16):Math.floor(n.width*16/9)};window.addEventListener("resize",l),r.addEventListener("fullscreenchange",l)}t.appendChild(a)}function loadImageNote(){const t=document.querySelectorAll("img"),o=Array.from(document.querySelectorAll(".img-row img")),c=document.querySelectorAll(".img-row");for(const i of t){if(o.includes(i))continue;const n=document.createElement("aside");n.innerText=i.alt,n.classList.add("img-note"),i.insertAdjacentElement("afterend",n)}for(const i of c){const n=i.querySelectorAll("img"),a=Array.from(n).map(s=>{const l=document.createElement("aside");return l.innerText=s.alt,l.classList.add("img-note"),l}),r=document.createElement("aside");r.classList.add("img-row-note"),a.forEach(s=>r.appendChild(s)),i.insertAdjacentElement("afterend",r)}}const SizeSufix=["w1k","w600","w1k_f","w2k","s600","s800"];function appendImgSizeOption(t,o){return t=removeImgSizeSufix(t),t+"-"+o}function removeImgSizeSufix(t){const o=SizeSufix.filter(c=>t.endsWith("-"+c))[0];return o&&(t=t.substring(0,t.length-o.length-1)),t}function initImagePreview(){const t=document.querySelectorAll(".markdown-body img"),o=document.querySelector(".img-viewer"),c=o.querySelector("img"),i=()=>{!n||(n=!1,o.classList.remove("show"))};o.querySelector(".button-close").onclick=i,o.onclick=a=>{a.preventDefault(),a.stopPropagation(),i()},c.onclick=a=>{a.preventDefault(),a.stopPropagation()},window.onwheel=a=>{a.preventDefault()},window.addEventListener("scroll",a=>{n&&a.preventDefault()}),window.addEventListener("scroll",a=>{n&&a.preventDefault()});let n=!1;for(const a of t)a.onclick=()=>{n||(c.src=removeImgSizeSufix(a.src),n=!0,setTimeout(()=>{o.classList.add("show")},34))}}function loadContentNav(){setTimeout(function(){var t=document.querySelector(".markdown-body"),o=document.querySelectorAll("#content-template"),c=Array.from(t.querySelectorAll("h2,h3,h4,h5,h6,h7,h8,h9"));const i=s=>{for(var l={header:"",url:"#",children:[]};n<c.length;n++){var d=parseInt(/H(\d)/.exec(c[n].tagName)[1]);if(c[n].id=c[n].innerText,d>=s){if(l.header!=""&&d<=s)return n--,l;d==s?l={header:c[n].innerText,url:`${location.protocol}//${location.host}${location.pathname}${location.search}#${c[n].id}`,children:[]}:d>s&&l.children.push(i(s+1))}else return n--,l}return l};var n=0,a=[];for(n=0;n<c.length;n++)a.push(i(2));var r={header:$("#title").innerText,url:`${location.protocol}//${location.host}${location.pathname}${location.search}#title`,children:a};o.forEach(s=>s.dataSource=r)})}function formatTime(t){t.time=SardineFish.API.Utils.formatDateTime(new Date(t.time)),t.comments.forEach(formatTime)}function loadComment(t){SardineFish.API.Comment.getByPid({pid:t,depth:6}).then(o=>{o.forEach(formatTime);var c=document.querySelector("#comment-template");o=o.sort((i,n)=>n.pid-i.pid),c.dataSource=o,$$(".comment-render .comment").forEach(function(i){var n=i.dataset.pid,a=i.dataset.name;i.querySelector(".button-reply").addEventListener("click",function(){window.cid=parseInt(n),$("#input-comment").dataset.text="Reply to "+a,$("#input-comment").innerHTML=""})})})}function initCommentPost(){$("#button-add-comment").addEventListener("click",function(){cid=pid,$("#input-comment").dataset.text="Tell me what you think",$("#input-comment").innerHTML=""}),$("#button-comment-send").addEventListener("click",function(){var t=$("#input-name").value,o=$("#input-email").value,c=$("#input-comment").innerText,i=CryptoJS.MD5(o).toString(),n=`https://www.gravatar.com/avatar/${i}?s=256&d=${encodeURIComponent("https://cdn-static.sardinefish.com/img/unknown-user-grey.png")}`;SardineFish.API.Comment.post({pid:cid},{name:t,email:o,text:c,avatar:n}).then(()=>{$("#input-comment").innerHTML="",loadComment(pid)})})}function loadPuzzle(){require.config({paths:{"crypto-js":"/lib/Script/crypto-js"}}),require(["crypto-js/crypto-js"],function(CryptoJS){var ans="U2FsdGVkX1/A4SaZPLVgnDY3SJxhtkwV8EgRK3WYb+spfsIOaicFaHfBBJ7ZE9lechvHNqLNQaQhAjVJxKji+w==",ansHash="ec1599cd561886e2e75238c6e826f48135dc0f7cf1d14f61cf36d1b5e5c20ae5",hints=["\u4F60\u4E00\u5B9A\u662F\u591C\u7A7A\u4E2D\u6700\u4EAE\u7684\u90A3\u9897\u2B50","\u795E\u8BF4\uFF0C\u8981\u6709\u5149\u3002","\u8FD9\u91CC\u4EC0\u4E48\u4E5F\u6CA1\u6709\uFF0C\u5173\u706F\u7761\u5427\u3002"];window.CryptoJS=CryptoJS;function AES_CBC_Decrypt(t,o){return CryptoJS.AES.decrypt(t,o,{mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.ZeroPadding}).toString(CryptoJS.enc.Utf8)}$$("*").forEach(el=>el.addEventListener("click",e=>{try{var x=Math.floor(e.pageX/2),y=Math.floor(e.pageY/2),key=`(${x}, ${y})`,dec=AES_CBC_Decrypt(ans,key),decHash=CryptoJS.SHA256(dec);decHash!=ansHash?$("#error-msg").innerText=hints[parseInt(Math.random()*hints.length)]:eval(dec)}catch(t){$("#error-msg").innerText=hints[parseInt(Math.random()*hints.length)]}}))})}function imagePostProcess(t){const o=t;var c="https://img.sardinefish.com/",i=/((?:https?:)?\/\/[^/]*.sardinefish.com\/|(?:localhost|127.0.0.1)(?:\:\d+)?\/)(.*)/;if(atob("aHR0cDovL2ltZy5zYXJkaW5lZmlzaC5jb20v"),i.test(t)){var n=i.exec(t)[2];t=c+n,t=appendImgSizeOption(t,"s800")}return console.log(`${o} -> ${t}`),t}function markdownItImagePostProcess(t){var o=t.renderer.rules.image;const c=t.renderer.rules.html_block,i=t.renderer.rules.html_inline;t.renderer.rules.image=function(a,r,s,l,d){var u=a[r],m=u.attrs[u.attrIndex("src")][1];return m=imagePostProcess(m),console.log(`${u.attrs[u.attrIndex("src")][1]} -> ${m}`),u.attrs[u.attrIndex("src")][1]=m,o(a,r,s,l,d)};const n=a=>{const r=a.content,s=document.createElement("div");s.innerHTML=r;for(const l of s.querySelectorAll("img"))l.src=imagePostProcess(l.src);a.content=s.innerHTML};t.renderer.rules.html_block=(a,r,s,l,d)=>{var u=a[r];return n(u),c(a,r,s,l,d)},t.renderer.rules.html_inline=(a,r,s,l,d)=>{var u=a[r];return n(u),i(a,r,s,l,d)}}function markedImagePostProcess(t){var o=new t.Renderer,c=o.image;return o.image=function(i,n,a){var r=i;return r=imagePostProcess(r),console.log(`${i} -> ${r}`),i=r,c.bind(o)(i,n,a)},o}
