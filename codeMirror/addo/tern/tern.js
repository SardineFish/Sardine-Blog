(function(A){if(typeof exports=="object"&&typeof module=="object"){A(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],A)}else{A(CodeMirror)}}})(function(e){e.TernServer=function(m){var l=this;this.options=m||{};var n=this.options.plugins||(this.options.plugins={});if(!n.doc_comment){n.doc_comment=true}this.docs=Object.create(null);if(this.options.useWorker){this.server=new a(this)}else{this.server=new tern.Server({getFile:function(o,p){return Y(l,o,p)},async:true,defs:this.options.defs||[],plugins:n})}this.trackChange=function(p,o){J(l,p,o)};this.cachedArgHints=null;this.activeArgHints=null;this.jumpStack=[];this.getHint=function(p,o){return H(l,p,o)};this.getHint.async=true};e.TernServer.prototype={addDoc:function(m,n){var l={doc:n,name:m,changed:null};this.server.addFile(m,B(this,l));e.on(n,"change",this.trackChange);return this.docs[m]=l},delDoc:function(m){var l=i(this,m);if(!l){return}e.off(l.doc,"change",this.trackChange);delete this.docs[l.name];this.server.delFile(l.name)},hideDoc:function(m){A(this);var l=i(this,m);if(l&&l.changed){c(this,l)}},complete:function(l){l.showHint({hint:this.getHint})},showType:function(n,l,m){S(this,n,l,"type",m)},showDocs:function(n,l,m){S(this,n,l,"documentation",m)},updateArgHints:function(l){h(this,l)},jumpToDef:function(l){M(this,l)},jumpBack:function(l){U(this,l)},rename:function(l){Z(this,l)},selectName:function(l){f(this,l)},request:function(o,r,t,n){var l=this;var s=N(this,o.getDoc());var p=I(this,s,r,n);var q=p.query&&this.options.queryOptions&&this.options.queryOptions[p.query.type];if(q){for(var m in q){p.query[m]=q[m]}}this.server.request(p,function(u,v){if(!u&&l.options.responseFilter){v=l.options.responseFilter(s,r,p,u,v)}t(u,v)})},destroy:function(){if(this.worker){this.worker.terminate();this.worker=null}}};var R=e.Pos;var L="CodeMirror-Tern-";var D=250;function Y(n,m,o){var l=n.docs[m];if(l){o(B(n,l))}else{if(n.options.getFile){n.options.getFile(m,o)}else{o(null)}}}function N(q,r,p){for(var o in q.docs){var l=q.docs[o];if(l.doc==r){return l}}if(!p){for(var m=0;;++m){o="[doc"+(m||"")+"]";if(!q.docs[o]){p=o;break}}}return q.addDoc(p,r)}function i(l,m){if(typeof m=="string"){return l.docs[m]}if(m instanceof e){m=m.getDoc()}if(m instanceof e.Doc){return N(l,m)}}function J(n,r,l){var m=N(n,r);var q=n.cachedArgHints;if(q&&q.doc==r&&V(q.start,l.to)<=0){n.cachedArgHints=null}var o=m.changed;if(o==null){m.changed=o={from:l.from.line,to:l.from.line}}var p=l.from.line+(l.text.length-1);if(l.from.line<o.to){o.to=o.to-(l.to.line-p)}if(p>=o.to){o.to=p+1}if(o.from>l.from.line){o.from=l.from.line}if(r.lineCount()>D&&l.to-o.from>100){setTimeout(function(){if(m.changed&&m.changed.to-m.changed.from>100){c(n,m)}},200)}}function c(l,m){l.server.request({files:[{type:"full",name:m.name,text:B(l,m)}]},function(n){if(n){window.console.error(n)}else{m.changed=null}})}function H(l,n,m){l.request(n,{type:"completions",types:true,docs:true,urls:true},function(u,p){if(u){return G(l,n,u)}var v=[],q="";var t=p.start,x=p.end;if(n.getRange(R(t.line,t.ch-2),t)=='["'&&n.getRange(x,R(x.line,x.ch+2))!='"]'){q='"]'}for(var r=0;r<p.completions.length;++r){var s=p.completions[r],w=g(s.type);if(p.guess){w+=" "+L+"guess"}v.push({text:s.name+q,displayText:s.displayName||s.name,className:w,data:s})}var y={from:t,to:x,list:v};var o=null;e.on(y,"close",function(){j(o)});e.on(y,"update",function(){j(o)});e.on(y,"select",function(z,Aa){j(o);var Ab=l.options.completionTip?l.options.completionTip(z.data):z.data.doc;if(Ab){o=b(Aa.parentNode.getBoundingClientRect().right+window.pageXOffset,Aa.getBoundingClientRect().top+window.pageYOffset,Ab);o.className+=" "+L+"hint-doc"}});m(y)})}function g(l){var m;if(l=="?"){m="unknown"}else{if(l=="number"||l=="string"||l=="bool"){m=l}else{if(/^fn\(/.test(l)){m="fn"}else{if(/^\[/.test(l)){m="array"}else{m="object"}}}}return L+"completion "+L+"completion-"+m}function S(m,o,l,p,n){m.request(o,p,function(s,t){if(s){return G(m,o,s)}if(m.options.typeTip){var q=m.options.typeTip(t)}else{var q=T("span",null,T("strong",null,t.type||"not found"));if(t.doc){q.appendChild(document.createTextNode(" â€” "+t.doc))}if(t.url){q.appendChild(document.createTextNode(" "));var r=q.appendChild(T("a",null,"[docs]"));r.href=t.url;r.target="_blank"}}K(o,q);if(n){n()}},l)}function h(n,x){A(n);if(x.somethingSelected()){return}var r=x.getTokenAt(x.getCursor()).state;var y=e.innerMode(x.getMode(),r);if(y.mode.name!="javascript"){return}var z=y.state.lexical;if(z.info!="call"){return}var s,w=z.pos||0,o=x.getOption("tabSize");for(var q=x.getCursor().line,t=Math.max(0,q-9),u=false;q>=t;--q){var l=x.getLine(q),v=0;for(var Aa=0;;){var m=l.indexOf("\t",Aa);if(m==-1){break}v+=o-(m+v)%o-1;Aa=m+1}s=z.column-v;if(l.charAt(s)=="("){u=true;break}}if(!u){return}var Ab=R(q,s);var p=n.cachedArgHints;if(p&&p.doc==x.getDoc()&&V(Ab,p.start)==0){return P(n,x,w)}n.request(x,{type:"type",preferFunction:true,end:Ab},function(Ac,Ad){if(Ac||!Ad.type||!(/^fn\(/).test(Ad.type)){return}n.cachedArgHints={start:Aa,type:W(Ad.type),name:Ad.exprName||Ad.name||"fn",guess:Ad.guess,doc:x.getDoc()};P(n,x,w)})}function P(p,m,l){A(p);var s=p.cachedArgHints,n=s.type;var q=T("span",s.guess?L+"fhint-guess":null,T("span",L+"fname",s.name),"(");for(var r=0;r<n.args.length;++r){if(r){q.appendChild(document.createTextNode(", "))}var o=n.args[r];q.appendChild(T("span",L+"farg"+(r==l?" "+L+"farg-current":""),o.name||"?"));if(o.type!="?"){q.appendChild(document.createTextNode(":\u00a0"));q.appendChild(T("span",L+"type",o.type))}}q.appendChild(document.createTextNode(n.rettype?") ->\u00a0":")"));if(n.rettype){q.appendChild(T("span",L+"type",n.rettype))}var t=m.cursorCoords(null,"page");p.activeArgHints=b(t.right+1,t.bottom,q)}function W(n){var q=[],m=3;function o(r){var t=0,u=m;for(;;){var s=n.charAt(m);if(r.test(s)&&!t){return n.slice(u,m)}if(/[{\[\(]/.test(s)){++t}else{if(/[}\]\)]/.test(s)){--t}}++m}}if(n.charAt(m)!=")"){for(;;){var p=n.slice(m).match(/^([^, \(\[\{]+): /);if(p){m+=p[0].length;p=p[1]}q.push({name:p,type:o(/[\),]/)});if(n.charAt(m)==")"){break}m+=2}}var l=n.slice(m).match(/^\) -> (.*)$/);return{args:q,rettype:l&&l[1]}}function M(l,n){function m(o){var p={type:"definition",variable:o||null};var q=N(l,n.getDoc());l.server.request(I(l,q,p),function(s,u){if(s){return G(l,n,s)}if(!u.file&&u.url){window.open(u.url);return}if(u.file){var r=l.docs[u.file],t;if(r&&(t=k(r.doc,u))){l.jumpStack.push({file:q.name,start:n.getCursor("from"),end:n.getCursor("to")});X(l,q,r,t.start,t.end);return}}G(l,n,"Could not find a definition.")})}if(!F(n)){C(n,"Jump to variable",function(o){if(o){m(o)}})}else{m()}}function U(m,n){var l=m.jumpStack.pop(),o=l&&m.docs[l.file];if(!o){return}X(m,N(m,n.getDoc()),o,l.start,l.end)}function X(m,p,l,o,n){l.doc.setSelection(o,n);if(p!=l&&m.options.switchToDoc){A(m);m.options.switchToDoc(l.name,l.doc)}}function k(t,o){var w=o.context.slice(0,o.contextOffset).split("\n");var q=o.start.line-(w.length-1);var n=R(q,(w.length==1?o.start.ch:t.getLine(q).length)-w[0].length);var s=t.getLine(q).slice(n.ch);for(var m=q+1;m<t.lineCount()&&s.length<o.context.length;++m){s+="\n"+t.getLine(m)}if(s.slice(0,o.context.length)==o.context){return o}var p=t.getSearchCursor(o.context,0,false);var r,x=Infinity;while(p.findNext()){var v=p.from(),u=Math.abs(v.line-n.line)*10000;if(!u){u=Math.abs(v.ch-n.ch)}if(u<x){r=v;x=u}}if(!r){return null}if(w.length==1){r.ch+=w[0].length}else{r=R(r.line+(w.length-1),w[w.length-1].length)}if(o.start.line==o.end.line){var l=R(r.line,r.ch+(o.end.ch-o.start.ch))}else{var l=R(r.line+(o.end.line-o.start.line),o.end.ch)}return{start:r,end:l}}function F(n){var m=n.getCursor("end"),l=n.getTokenAt(m);if(l.start<m.ch&&l.type=="comment"){return false}return/[\w)\]]/.test(n.getLine(m.line).slice(Math.max(m.ch-1,0),m.ch+1))}function Z(m,n){var l=n.getTokenAt(n.getCursor());if(!/\w/.test(l.string)){return G(m,n,"Not at a variable")}C(n,"New name for "+l.string,function(o){m.request(n,{type:"rename",newName:o,fullDocs:true},function(p,q){if(p){return G(m,n,p)}d(m,q.changes)})})}function f(m,n){var l=N(m,n.doc).name;m.request(n,{type:"refs"},function(s,t){if(s){return G(m,n,s)}var r=[],o=0;for(var p=0;p<t.refs.length;p++){var q=t.refs[p];if(q.file==l){r.push({anchor:q.start,head:q.end});if(V(o,q.start)>=0&&V(o,q.end)<=0){o=r.length-1}}}n.setSelections(r,o)})}var O=0;function d(r,t){var n=Object.create(null);for(var p=0;p<t.length;++p){var o=t[p];(n[o.file]||(n[o.file]=[])).push(o)}for(var q in n){var s=r.docs[q],m=n[q];if(!s){continue}m.sort(function(v,u){return V(u.start,v.start)});var l="*rename"+(++O);for(var p=0;p<m.length;++p){var o=m[p];s.doc.replaceRange(o.text,o.start,o.end,l)}}}function I(p,r,q,o){var m=[],t=0,u=!q.fullDocs;if(!u){delete q.fullDocs}if(typeof q=="string"){q={type:q}}q.lineCharPositions=true;if(q.end==null){q.end=o||r.doc.getCursor("end");if(r.doc.somethingSelected()){q.start=r.doc.getCursor("start")}}var s=q.start||q.end;if(r.changed){if(r.doc.lineCount()>D&&u!==false&&r.changed.to-r.changed.from<100&&r.changed.from<=s.line&&r.changed.to>q.end.line){m.push(Q(r,s,q.end));q.file="#0";var t=m[0].offsetLines;if(q.start!=null){q.start=R(q.start.line- -t,q.start.ch)}q.end=R(q.end.line-t,q.end.ch)}else{m.push({type:"full",name:r.name,text:B(p,r)});q.file=r.name;r.changed=null}}else{q.file=r.name}for(var n in p.docs){var l=p.docs[n];if(l.changed&&l!=r){m.push({type:"full",name:l.name,text:B(p,l)});l.changed=null}}return{query:q,files:m}}function Q(o,m,q){var v=o.doc;var x=null,r=null,s,w=4;for(var l=m.line-1,n=Math.max(0,l-50);l>=n;--l){var z=v.getLine(l),u=z.search(/\bfunction\b/);if(u<0){continue}var Aa=e.countColumn(z,null,w);if(x!=null&&x<=Aa){continue}x=Aa;r=l}if(r==null){r=n}var t=Math.min(v.lastLine(),q.line+20);if(x==null||x==e.countColumn(v.getLine(m.line),null,w)){s=t}else{for(s=q.line+1;s<t;++s){var Aa=e.countColumn(v.getLine(s),null,w);if(Aa<=x){break}}}var y=R(r,0);return{type:"part",name:o.name,offsetLines:y.line,text:v.getRange(y,R(s,0))}}var V=e.cmpPos;function T(p,n){var m=document.createElement(p);if(n){m.className=n}for(var l=2;l<arguments.length;++l){var o=arguments[l];if(typeof o=="string"){o=document.createTextNode(o)}m.appendChild(o)}return m}function C(m,l,n){if(m.openDialog){m.openDialog(l+": <input type=text>",n)}else{n(prompt(l,""))}}function K(n,r){if(n.state.ternTooltip){j(n.state.ternTooltip)}var m=n.cursorCoords();var p=n.state.ternTooltip=b(m.right+1,m.bottom,r);function q(){l=true;if(!o){s()}}function s(){n.state.ternTooltip=null;if(!p.parentNode){return}n.off("cursorActivity",s);n.off("blur",s);n.off("scroll",s);E(p)}var o=false,l=false;e.on(p,"mousemove",function(){o=true});e.on(p,"mouseout",function(t){if(!e.contains(p,t.relatedTarget||t.toElement)){if(l){s()}else{o=false}}});setTimeout(q,1700);n.on("cursorActivity",s);n.on("blur",s);n.on("scroll",s)}function b(m,n,o){var l=T("div",L+"tooltip",o);l.style.left=m+"px";l.style.top=n+"px";document.body.appendChild(l);return l}function j(m){var l=m&&m.parentNode;if(l){l.removeChild(m)}}function E(l){l.style.opacity="0";setTimeout(function(){j(l)},1100)}function G(m,n,l){if(m.options.showError){m.options.showError(n,l)}else{K(n,String(l))}}function A(l){if(l.activeArgHints){j(l.activeArgHints);l.activeArgHints=null}}function B(l,n){var m=n.doc.getValue();if(l.options.fileFilter){m=l.options.fileFilter(m,n.name,n.doc)}return m}function a(m){var l=m.worker=new Worker(m.options.workerScript);l.postMessage({type:"init",defs:m.options.defs,plugins:m.options.plugins,scripts:m.options.workerDeps});var p=0,o={};function n(r,q){if(q){r.id=++p;o[p]=q}l.postMessage(r)}l.onmessage=function(q){var r=q.data;if(r.type=="getFile"){Y(m,r.name,function(t,s){n({type:"getFile",err:String(t),text:s,id:r.id})})}else{if(r.type=="debug"){window.console.log(r.message)}else{if(r.id&&o[r.id]){o[r.id](r.err,r.body);delete o[r.id]}}}};l.onerror=function(q){for(var r in o){o[r](q)}o={}};this.addFile=function(q,r){n({type:"add",name:q,text:r})};this.delFile=function(q){n({type:"del",name:q})};this.request=function(q,r){n({type:"req",body:q},r)}}});