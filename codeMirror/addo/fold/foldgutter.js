(function(A){if(typeof exports=="object"&&typeof module=="object"){A(require("../../lib/codemirror"),require("./foldcode"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","./foldcode"],A)}else{A(CodeMirror)}}})(function(J){J.defineOption("foldGutter",false,function(O,N,M){if(M&&M!=J.Init){O.clearGutter(O.state.foldGutter.options.gutter);O.state.foldGutter=null;O.off("gutterClick",L);O.off("change",G);O.off("viewportChange",F);O.off("fold",I);O.off("unfold",I);O.off("swapDoc",K)}if(N){O.state.foldGutter=new D(E(N));K(O);O.on("gutterClick",L);O.on("change",G);O.on("viewportChange",F);O.on("fold",I);O.on("unfold",I);O.on("swapDoc",K)}});var C=J.Pos;function D(M){this.options=M;this.from=this.to=0}function E(M){if(M===true){M={}}if(M.gutter==null){M.gutter="CodeMirror-foldgutter"}if(M.indicatorOpen==null){M.indicatorOpen="CodeMirror-foldgutter-open"}if(M.indicatorFolded==null){M.indicatorFolded="CodeMirror-foldgutter-folded"}return M}function B(O,N){var P=O.findMarksAt(C(N));for(var M=0;M<P.length;++M){if(P[M].__isFold&&P[M].find().from.line==N){return P[M]}}}function A(N){if(typeof N=="string"){var M=document.createElement("div");M.className=N+" CodeMirror-guttermarker-subtle";return M}else{return N.cloneNode(true)}}function H(S,N,P){var O=S.state.foldGutter.options,M=N;var R=S.foldOption(O,"minFoldSize");var Q=S.foldOption(O,"rangeFinder");S.eachLine(N,P,function(U){var W=null;if(B(S,M)){W=A(O.indicatorFolded)}else{var T=C(M,0);var V=Q&&Q(S,T);if(V&&V.to.line-V.from.line>=R){W=A(O.indicatorOpen)}}S.setGutterMarker(U,O.gutter,W);++M})}function K(N){var M=N.getViewport(),O=N.state.foldGutter;if(!O){return}N.operation(function(){H(N,M.from,M.to)});O.from=M.from;O.to=M.to}function L(Q,P,N){var R=Q.state.foldGutter;if(!R){return}var M=R.options;if(N!=M.gutter){return}var O=B(Q,P);if(O){O.clear()}else{Q.foldCode(C(P,0),M.rangeFinder)}}function G(N){var O=N.state.foldGutter;if(!O){return}var M=O.options;O.from=O.to=0;clearTimeout(O.changeUpdate);O.changeUpdate=setTimeout(function(){K(N)},M.foldOnChangeTimeSpan||600)}function F(N){var O=N.state.foldGutter;if(!O){return}var M=O.options;clearTimeout(O.changeUpdate);O.changeUpdate=setTimeout(function(){var P=N.getViewport();if(O.from==O.to||P.from-O.to>20||O.from-P.to>20){K(N)}else{N.operation(function(){if(P.from<O.from){H(N,P.from,O.from);O.from=P.from}if(P.to>O.to){H(N,O.to,P.to);O.to=P.to}})}},M.updateViewportTimeSpan||400)}function I(O,M){var P=O.state.foldGutter;if(!P){return}var N=M.line;if(N>=P.from&&N<P.to){H(O,N,N+1)}}});